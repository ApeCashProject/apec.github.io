---
layout: default
title: ApeCash Project
---

  <body class="w-100 sans-serif bg-white">

<main class="mw7 center" role="main">
      
<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
<script src='https://apecashproject.github.io/ethereumjs-all-2017-10-31.min.js'></script>
<script src='https://apecashproject.github.io/moment.min.js'></script>
	<script src='https://programtheblockchain.com/js/jquery-3.2.1.min.js'></script>

<div class='flex-l mt2 w8 center article-container'>
<article class="cf pv5 ph3 ph4-ns w-100">
  <header>
    <h1 class="f1 mb1">
      Initial Coin Offering Example
    </h1>
  </header>
  <div class="lh-copy fw3 f4 dark-gray">
    <style>
  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    to {
      transform:rotate(1turn);
    }
  }
</style>

<div id="spinner" class="mt5">
  <div style="margin: 0px auto; border-radius: 100%; border-width: 3px; border-style: solid; border-color: rgb(33, 150, 243) rgb(238, 238, 238) rgb(238, 238, 238); border-image: initial; width: 32px; height: 32px; animation: spin 0.8s linear infinite;"></div>
  <small class="tc db f6 black-60">Loading...</small>
</div>
<div id="ui" class="dn">
  <p class="mt4">
    Your current balance: <span id="owned">0</span> APEc.
    Buy more! Each token costs 0.000008 ETH.
  </p>
  <form id="buyForm" class="br2-ns">
    <fieldset class="cf bn ma0 pa0">
      <div class="cf">
        <label class="clip" for="number">Number of tokens to buy</label>
        <input class="f6 f5-l input-reset bn bg-near-white fl black-80 pa3 lh-solid w-100 w-75-m w-80-l br2-ns br--left-ns" placeholder="Number of tokens to buy" type="number" name="number" value="1" min="1" id="number">
        <input class="f6 f5-l button-reset fl pv3 tc bn bg-animate bg-green hover-bg-dark-green white pointer w-100 w-25-m w-20-l br2-ns br--right-ns" type="submit" value="Buy Tokens">
      </div>
    </fieldset>
  </form>

  <div class="bg-moon-gray br-pill h1 overflow-y-hidden mt3">
    <div id="progress" class="bg-blue br-pill h1" style="width:0px"></div>
  </div>
  <small class="f6 black-60 db mb2 tr"><span id="sold">0</span> / <span id="total">0</span> tokens sold so far</small>

  <div class="flex items-center justify-center pa4 bg-lightest-blue navy mt4">
    <svg class="w1" data-icon="info" viewBox="0 0 32 32" style="fill:currentcolor;width:80px">
      <title>info icon</title>
      <path d="M16 0 A16 16 0 0 1 16 32 A16 16 0 0 1 16 0 M19 15 L13 15 L13 26 L19 26 z M16 6 A3 3 0 0 0 16 12 A3 3 0 0 0 16 6"></path>
    </svg>
    <span class="lh-title ml3"><strong>NOTE</strong>: Due to a bug in MetaMask, events may not work after switching networks (e.g. from the main network to the Ropsten test network). If you experience this, you need to restart the browser after switching to the desired network.</span>
  </div>
</div>



<script>
  var minimalTokenABI = [
  	{
  		"constant": true,
  		"inputs": [
  			{
  				"name": "",
  				"type": "address"
  			}
  		],
  		"name": "balanceOf",
  		"outputs": [
  			{
  				"name": "",
  				"type": "uint256"
  			}
  		],
  		"payable": false,
  		"stateMutability": "view",
  		"type": "function"
  	},
  	{
  		"anonymous": false,
  		"inputs": [
  			{
  				"indexed": true,
  				"name": "from",
  				"type": "address"
  			},
  			{
  				"indexed": true,
  				"name": "to",
  				"type": "address"
  			},
  			{
  				"indexed": false,
  				"name": "value",
  				"type": "uint256"
  			}
  		],
  		"name": "Transfer",
  		"type": "event"
  	},
  ];

  var saleABI = [
  	{
  		"constant": true,
  		"inputs": [],
  		"name": "tokensSold",
  		"outputs": [
  			{
  				"name": "",
  				"type": "uint256"
  			}
  		],
  		"payable": false,
  		"stateMutability": "view",
  		"type": "function"
  	},
  	{
  		"constant": true,
  		"inputs": [],
  		"name": "tokenContract",
  		"outputs": [
  			{
  				"name": "",
  				"type": "address"
  			}
  		],
  		"payable": false,
  		"stateMutability": "view",
  		"type": "function"
  	},
  	{
  		"constant": true,
  		"inputs": [],
  		"name": "price",
  		"outputs": [
  			{
  				"name": "",
  				"type": "uint256"
  			}
  		],
  		"payable": false,
  		"stateMutability": "view",
  		"type": "function"
  	},
  	{
  		"anonymous": false,
  		"inputs": [
  			{
  				"indexed": false,
  				"name": "buyer",
  				"type": "address"
  			},
  			{
  				"indexed": false,
  				"name": "amount",
  				"type": "uint256"
  			}
  		],
  		"name": "Sold",
  		"type": "event"
  	},
  	{
  		"constant": false,
  		"inputs": [
  			{
  				"name": "numberOfTokens",
  				"type": "uint256"
  			}
  		],
  		"name": "buyTokens",
  		"outputs": [],
  		"payable": true,
  		"stateMutability": "payable",
  		"type": "function"
  	},
  	{
  		"constant": false,
  		"inputs": [],
  		"name": "endSale",
  		"outputs": [],
  		"payable": false,
  		"stateMutability": "nonpayable",
  		"type": "function"
  	},
  	{
  		"inputs": [
  			{
  				"name": "_tokenContract",
  				"type": "address"
  			},
  			{
  				"name": "_price",
  				"type": "uint256"
  			}
  		],
  		"payable": false,
  		"stateMutability": "nonpayable",
  		"type": "constructor"
  	}
  ];
  var saleAddress = '0xceb3276Fb25EDBBcA9f5918A02ED81f8A6cEFAD3';

  var saleContract = web3.eth.contract(saleABI).at(saleAddress);

  // These values could be determined dynamically at runtime, but they never
  // change, so there's no harm in hard-coding them, and it saves us network
  // round-trips.
  var tokenAddress = '0xc956fdb88d2e5b71e22d63313624e42d4757e7f9';
  var tokenContract = web3.eth.contract(minimalTokenABI).at(tokenAddress);
  var decimals = 18;
  var price = 8000000000000;

  // "Animate" by changing the text with each animation step.
  function animateTo(el, value) {
    $({ number: parseFloat(el.text().replace(/[^\d.]/g, '')) }).animate(
      { number: value },
      {
        step: function () {
          el.text(Math.floor(this.number).toLocaleString());
        },
        complete: function () {
          el.text(this.number.toLocaleString());
        },
      });
  }

  var start = +(new Date());
  function updateUI(owned, sold, remaining) {
    // Delay first UI update until the spinner has been visible for 1 second.
    if (+(new Date()) - start < 1000) {
      return window.setTimeout(function () {
        updateUI(owned, sold, remaining);
      }, 1000 - +(new Date()) + start);
    }

    // sold and total are both BigNumbers
    var total = sold.plus(remaining);

    $('#ui').show();
    $('#spinner').hide();
    animateTo($('#owned'), owned.toNumber());
    animateTo($('#sold'), sold.toNumber());
    animateTo($('#total'), total.toNumber());
    $('#price')
    $('#progress').animate({
      // Safe BigNumber math
      width: Math.round(sold.mul(100).div(total).toNumber()).toString() + '%',
    });
  }

  $('#buyForm').submit(function (e) {
    // Prevent the browser from POSTing the form.
    e.preventDefault();

    var numberOfTokens = web3.toBigNumber($('#number').val());
    saleContract.buyTokens.sendTransaction(numberOfTokens, {
      value: numberOfTokens.mul(price),
    }, function () {
      // Nothing to do here. If the transaction is successful, it will trigger
      // events that we're already monitoring.
    });
  });

  function loadData(blockNumber) {
    log("Loading data from contracts...")

    var balance, sold, remaining;

    // Callback that waits for all three pieces of data before proceeding
    function updateWhenDone() {
      if (balance !== undefined && sold !== undefined &&
          remaining !== undefined) {
        log("Updating UI.");
        updateUI(balance.div(10**decimals), sold, remaining.div(10**decimals));
      }
    }

    // Fetch in parallel
    // User's balance
    tokenContract.balanceOf.call(web3.eth.defaultAccount, {}, blockNumber,
      function (err, _balance) {
        if (err) return error(err);
        balance = _balance;
        updateWhenDone();
      });
    // Tokens sold so far
    saleContract.tokensSold.call({}, blockNumber,
      function (err, _sold) {
        if (err) return error(err);
        sold = _sold;
        updateWhenDone();
      });
    // Remaining inventory (sale contract's balance)
    tokenContract.balanceOf.call(saleAddress, {}, blockNumber,
      function (err, _remaining) {
        if (err) return error(err);
        remaining = _remaining;
        updateWhenDone();
      });
  }

  function initialize() {
    web3.eth.getBlockNumber(function (err, lastSeenBlock) {
      // Load data for the initial block
      loadData(lastSeenBlock);

      // Handler for events that necessitate a UI update
      function changeHandler(err, data) {
        if (err) return error(err);

        // Only if we haven't already fetched data for this block
        if (data.blockNumber > lastSeenBlock) {
          lastSeenBlock = data.blockNumber;
          loadData(lastSeenBlock);
        }
      }

      // The Sold event tells us when the number of sold tokens changes.
      saleContract.Sold(changeHandler);

      // We display the user's balance as well as the sale contract's
      // balance, so we need to monitor transfers to both.
      tokenContract.Transfer({
        to: [ saleAddress, web3.eth.defaultAccount ]
      }, changeHandler);

      // To display an accurate balance, we also need to monitor transfers out
      // of the user's account.
      tokenContract.Transfer({
        from: web3.eth.defaultAccount
      }, changeHandler);
    });
  }

  $(function () {
    if (typeof(web3) === "undefined") {
      error("Unable to find web3. " +
      "Please run MetaMask (or something else that injects web3).");
    } else {
      log("Found injected web3.");
      web3 = new web3.providers.HttpProvider('https://mainnet.infura.io/v3/c91a941e3e5641d5b3acddaea87b5fc6');
      if (web3.version.network !== '1') {
        error("Wrong network detected. Please switch to the Ethereum Mainnet.“);
      } else {
        log("Connected to the Ethereum Mainnet.“);
        if (web3.eth.defaultAccount === undefined) {
          error("No accounts found. If you're using MetaMask, " +
  				      "please unlock it first.");
        } else {
          initialize();
        }
        var initialAccount = web3.eth.defaultAccount;
        window.setInterval(function () {
          if (web3.eth.defaultAccount !== initialAccount) {
            window.location.reload();
          }
        }, 500);
      }
    }
  });
</script>

  </div>
</article>
</div>

<h2>Log</h2>
<div class="code f6 lh-solid overflow-auto ph3 ba b--moon-gray" style="height:16em" id="log">
</div>
<script>
	function log(message) {
		$('#log').append($('<p>').text(message));
		$('#log').scrollTop($('#log').prop('scrollHeight'));
	}

	function error(message) {
		$('#log').append($('<p>').addClass('dark-red').text(message));
		$('#log').scrollTop($('#log').prop('scrollHeight'));
	}

	function waitForReceipt(hash, cb) {
		web3.eth.getTransactionReceipt(hash, function (err, receipt) {
			if (err) {
				error(err);
			}

			if (receipt !== null) {
				
				if (cb) {
					cb(receipt);
				}
			} else {
				
				window.setTimeout(function () {
					waitForReceipt(hash, cb);
				}, 1000);
			}
		});
	}
</script>

    </main>
	  
</body>
